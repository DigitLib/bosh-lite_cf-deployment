#!/bin/bash -ex
## Install and create Bosh lite under vbox
#requires vbox
#requires bosh2 cli
#requires cf cli


#TODO: Set enviornment variables for installation directories
BOSH_ENV_ALIAS=vbox
BOSH_LITE_DIRECTORY=~/workspace/bosh-deployment
DEPLOYEMENT_DIRECTORY=~/workspace/deployments/$BOSH_ENV_ALIAS


##Create Bosh-lite
#source for these steps: http://bosh.io/docs/bosh-lite.html
#clone bosh-deployment
#TODO: add check to see if it already exists
git clone https://github.com/cloudfoundry/bosh-deployment $BOSH_LITE_DIRECTORY


#set up your workspace
#TODO: add check to see if it already exists 
mkdir -p $DEPLOYEMENT_DIRECTORY

#edit deployment manifest
#TODO: Raise ram
#TODO: raise disk
#TODO: Raise CPUs

#create bosh director
bosh create-env $BOSH_LITE_DIRECTORY/bosh.yml \
  --state ~/workspace/deployments/vbox/state.json \
  -o $BOSH_LITE_DIRECTORY/virtualbox/cpi.yml \
  -o $BOSH_LITE_DIRECTORY/virtualbox/outbound-network.yml \
  -o $BOSH_LITE_DIRECTORY/bosh-lite.yml \
  -o $BOSH_LITE_DIRECTORY/bosh-lite-runc.yml \
  -o $BOSH_LITE_DIRECTORY/jumpbox-user.yml \
  --vars-store  $DEPLOYEMENT_DIRECTORY/creds.yml \
  -v director_name="Bosh Lite Director" \
  -v internal_ip=192.168.50.6 \
  -v internal_gw=192.168.50.1 \
  -v internal_cidr=192.168.50.0/24 \
  -v outbound_network_name=NatNetwork

#Set bosh log-in info
bosh alias-env $BOSH_ENV_ALIAS -e 192.168.50.6 --ca-cert <(bosh int $DEPLOYEMENT_DIRECTORY/creds.yml --path /director_ssl/ca)
export BOSH_CLIENT=admin
export BOSH_CLIENT_SECRET=`bosh int $DEPLOYEMENT_DIRECTORY/creds.yml --path /admin_password`


#confirm works
bosh -e vbox env

##Deploy cf-deployment
#source for these steps(https://github.com/cloudfoundry/cf-deployment#deploying-cf)
#TODO: add check to see if it already exists
git clone https://github.com/cloudfoundry/cf-deployment $DEPLOYEMENT_DIRECTORY/cf-deployment

#edit deployment manifest 
#reduce disk sizes
#reduce memory sizes

#configure cloud config (this file need to be tweaked)
bosh -e vbox update-cloud-config $DEPLOYEMENT_DIRECTORY/cf-deployment/bosh-lite/cloud-config.yml -n


bosh -e vbox upload-stemcell https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-trusty-go_agent


#deploy the environment
bosh -e vbox -d cf deploy $DEPLOYEMENT_DIRECTORY/cf-deployment/cf-deployment.yml \
  -o  $DEPLOYEMENT_DIRECTORY/cf-deployment/operations/bosh-lite.yml \
  -o   $DEPLOYEMENT_DIRECTORY/cf-deployment/operations/scale-to-one-az.yml \
  --vars-store  $DEPLOYEMENT_DIRECTORY/cf-deployment/deployment-vars.yml \
  -v system_domain=bosh-lite.com \
  --recreate \
  --fix \
  -n

#run smoketests
bosh -e vbox -d cf run-errand smoke-tests
bosh -e vbox -d cf run-errand smoke_tests

#set env vars for cf logins
cf login -a https://api.bosh-lite.com --skip-ssl-validation -u admin  -p `bosh int $DEPLOYEMENT_DIRECTORY/cf-deployment/deployment-vars.yml  --path /cf_admin_password`
